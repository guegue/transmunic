{% extends "base.html" %}
{% load static thumbnail chartit %}
{% load humanize %} 
{% load mathfilters %}
{% load core_extras %} 
{% block titulo %}
{{ municipio }}
{% endblock %}

{% block main_content %}
	{% descargar_excel "oim-all" %}
    <h2 class="titular">Origen de los ingresos {% if municipio %} {{ municipio }} {% endif %}{% if year %}{{ year }}{% endif %}</h2>
    <form method="GET">
    <select name="year">
    {% for ayear in year_list %}
        <option {% if ayear == year|add:"0" %}selected{% endif %} value="{{ayear}}">{{ayear}}</option>
    {% endfor %}
    </select>
    <select name="municipio">
    <option value="">Consolidado Municipal</option>
    {% for amunicipio in municipio_list %}
        <option {% if amunicipio.slug == municipio.slug %}selected{% endif %} value="{{amunicipio.slug}}">{{amunicipio}}</option>
    {% endfor %}
    </select>
    <input type="submit" value="Buscar" class="btn btn-primary"/>
    </form>
    <ul id="oimTab" class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active"><a href="#asignados" aria-controls="asignados" role="tab" data-toggle="tab">Asignado y ejecutado anual</a></li>
        <li role="presentation"><a href="#oimmodificacion" aria-controls="oimmodificacion" role="tab" data-toggle="tab">Modificaciones al presupuesto</a></li>
        <li role="presentation"><a href="#oimorigen" aria-controls="oimorigen" role="tab" data-toggle="tab">Informaci&oacute;n hist&oacute;rica</a></li>
    </ul>
    {% if municipio and charts.4 %}
        {{ charts|load_charts:"ejecutado, comparativo_anios, comparativo2, comparativo3, tipo, asignado_barra, barra" }}
    {% else %}
        {{ charts|load_charts:"ejecutado,comparativo2,tipo,comparativo3,comparativo_anios" }}
    {% endif %}
    <div id="oimTabContent" class="tab-content">
      <div role="tabpanel" class="tab-pane fade active in" id="asignados" aria-labelledby="asignados-tab">
        <!--maribel 20/07 - ingresos resumen -->
        <div class="row alert alert-success">
            <div class="col-md-12">
                <div class="col-md-4">
                    <img src="{% static 'img/gfasignado.png' %}" class="img-responsive margen pull-left" alt="ingreso de funcionamiento asignado" />
                    <h3 class="titular" data-toggle="popover" title="Presupuestado" data-content="Indica el Porcentaje que Los Municipios  a nivel nacional destinaron para cubrir los ingresos de administración y prestación de los">Presupuestado</h3>
                    <span class="cifra grande text-primary">{{ asignado|intcomma }}</span>
                </div>
                <div class="col-md-4">
                    <img src="{% static 'img/gf.png' %}" class="img-responsive margen pull-left" alt="ingreso de funcionamiento asignado" />
                    <h3>Ejecutado </h3><span class="cifra text-warning grande">{{ ejecutado|intcomma }}</span>
                </div>
                {% if municipio %}
                    <div class="col-md-4">
                    <img src="{% static 'img/categoria2.png' %}" class="img-responsive margen pull-left" alt="Categoria de municipio" />
                    <h3>Categor&iacute;a de municipio </h3><span class="cifra text-success grande">{{ mi_clase.clasificacion }}</span>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="separador"></div>
    <!--Fin de resumen-->
          <!--maribel 20/07 ogim-tabla1 -->
          <div class="col-md-5">
              <h3>Ingresos del período</h3>
              <h4 class="text-info">Porcentaje del ingreso total
              <a class="btn btn-success" role="button" data-toggle="collapse" href="#collapsepastel"  aria-expanded="false" aria-controls="collapseExample">Ver gráfico </a>
              </h4>
              <hr />
              <div class="collapse col-md-4" id="collapsepastel">
                <div class="well">
                <div id='ejecutado' class="col-md-4"> Chart will be rendered here </div>
                </div>
              </div>
                <table class="table">
                  <tr class="info"> <th colspan="2">Rubros ingresos</th><th>Inicial</th> <th>Ejecutado</th> </tr>
                  {% for total in totales %}
                  <tr>
                    <td><img src="/static/img/{{ total.subsubtipoingreso__origen__nombre }}.png" class="pull-left" height="40" alt="{{ total.subsubtipoingreso__origen__nombre }}" />
                    </td>
                    <td> <h4>{{ total.subsubtipoingreso__origen__nombre }}</h4> </td>
                    <td><span class="btn btn-info col-md-12 cifra">{{ total.asignado_percent|floatformat:1 }}%</span></td>
                    <td><span class="btn btn-info col-md-12 cifra">{{ total.ejecutado_percent|floatformat:1 }}%</span></td>
                  </tr>
                {% endfor %}
             </table>
          </div> 
          
        <!-- maribel 20/07- oim-tabla2 -->
        <div class="col-md-6">
        	{% descargar_excel "oim1" %}
            <h3>Ingresos del período</h3>
            <h4>Ingresos en millones de córdobas corrientes  <a class="btn btn-success" role="button" data-toggle="collapse" href="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                ver gráfico
            </a>
            </h4>
            <div class="collapse" id="collapseExample">
                <div class="well">
                    {% if municipio %}
                      <div id='comparativo2'> Chart will be rendered here </div>
                    {% else %}
                      <div id='tipo'> Chart will be rendered here </div>
                    {% endif %}
                </div>
            </div>
            <table class="table table-condensed">                                       
                <tr class="info"> 
                    <th>Rubros de ingresos</th> 
                    <th>Inicial</th> 
                    <th>Ejecutado</th> 
                    <th><a href="#" data-toggle="tooltip" data-original-title="Ejecutado/Inicial" class="link-info">%</a></th>
                </tr>
                {% for row in rubros %}                                                     
                <tr>                                                                        
                    <td>{{ row.subsubtipoingreso__origen__nombre}}</td>                                    
                    <td class="text-right">{{ row.asignado|intcomma }}</td>
                    <td class="text-right">{{ row.ejecutado|intcomma }}</td>
                    {% if row.asignado %}                                                   
                        <td class="montos">{{ row.ejecutado|div:row.asignado|mul:100|floatformat:1 }}%</td>
                    {% endif %}                                                             
                </tr>                                                                       
                {% endfor %}                                                                
                <tr class="success bold">                                                   
                    <td>TOTAL</td>                                                          
                    <td>{{ asignado|intcomma }}</td>                                        
                    <td>{{ ejecutado|intcomma }}</td>                                       
                    {% if asignado %}<td class="montos">{{ ejecutado|div:asignado|mul:100|floatformat:1 }}%</td></tr>{% endif %}
            </table>                                                                    
        </div>
        <!-- /fin oim-tabla2 -->                                                      
        <hr />
        <div class="col-md-12 alert alert-success"  role="alert">
            <div class="center-block center"><h2>Eficiencia en recaudación municipal</h2></div>
            <div class="col-md-6">
                    <img src="{% static 'img/oim-asignadop.png' %}" class="img-responsive margen pull-left" alt="ingreso de funcionamiento asignado" />
                    <h3 class="titular" data-toggle="popover" title="Presupuestado" data-content="Indica el Porcentaje que Los Municipios  a nivel nacional destinaron para cubrir los ingresos de administración y prestación de los">Presupuestado</h3>
                    <span class="cifra grande text-primary">{{ rubrosp|total_sum:'asignado'|floatformat:2|intcomma }}</span>
            </div>
            <div class="col-md-6">
                    <img src="{% static 'img/oim-asignadop.png' %}" class="img-responsive margen pull-left" alt="ingreso de funcionamiento asignado" />
                    <h3>Ejecutado </h3><span class="cifra text-warning grande">{{ rubrosp|total_sum:'ejecutado'|floatformat:2|intcomma }}</span>
            </div>
            <div class="separador"></div>
            <div class="center"><a class="btn btn-success" role="button" data-toggle="collapse" href="#collapseeficiencia"  aria-expanded="false" aria-controls="collapseExample">Consultar detalles </a></div>
              <hr />
              <div class="collapse col-md-9" id="collapseeficiencia">
                <div class="well">
                			{% descargar_excel "oim2" %}
                            <h4>Recaudación en millones de córdobas corrientes</h3>
                            <table class="table table-condensed">                                       
                                <tr class="info"> 
                                    <th>Rubro</th> 
                                    <th>Inicial</th> 
                                    <th>Ejecutado</th> 
                                    <th><a href="#" data-toggle="tooltip" data-original-title="Ejecutado/Inicial" class="link-info">%</a></th>
                                </tr>
                                {% for row in rubrosp %}                                                     
                                <tr>                                                                        
                                    <td>{{ row.subtipoingreso__nombre }}</td>                                    
                                    <td class="text-right">{{ row.asignado|intcomma }}</td>                                    
                                    <td class="text-right">{{ row.ejecutado|intcomma }}</td>                                   
                                    {% if row.asignado %}                                                   
                                        <td class="montos text-right">{{ row.ejecutado|div:row.asignado|mul:100|floatformat:1 }}%</td>
                                    {% endif %}                                                             
                                </tr>                                                                       
                                {% endfor %}                                                                
                                <tr class="success bold">                                                   
                                    <td>TOTAL</td>                                                          
                                    <td class="text-right">{{ rubrosp|total_sum:'asignado'|floatformat:2|intcomma }}</td>                                        
                                    <td class="text-right">{{ rubrosp|total_sum:'ejecutado'|floatformat:2|intcomma }}</td>                                        
                                    <td class="montos">{{ rubrosp|div:asignado|mul:100|floatformat:1 }}</td>
                                </tr>       
                            </table>                                                                    
                           <!-- /fin oim-tabla3 -->                                                      
                </div>
              </div>
        </div>
        <br clear="all" />
        <hr />
        <div class="col-md-12">
            <!-- maribel 06/07 oimtabla4 nacional -->
            {% if not municipio %}
                <div class="col-md-6">
                	{% descargar_excel "oim3" %}
                    <h3> Recaudación por habitante en cada categoría municipal</h3>
                    <h4 class="text-info">Córdobas Corrientes</h4>
                    <table class="table table-condensed col-md-3">
                        <tr class="info"><th>Categoría de municipio</th> <th>Presupuestado</th> <th>Ejecutado</th></tr>
                        {% for row in porclasep %}
                        <tr>
                            <td class="text-center">{{ row.clasificacion }}</td>
                            <td class="text-right">{% if row.asignado %}{{ row.asignado|floatformat:2|intcomma }}{% else %} 0 {% endif %}</td>
                            <td class="text-right">{% if row.ejecutado %}{{ row.ejecutado|floatformat:2|intcomma }} {% else %} 0 {% endif %}</td>
                        </tr>
                        {% endfor %}
                        <tr class="success">
                            <td><strong>MEDIA NACIONAL</strong></td>
                            <td class="text-right"><strong>{{ porclasep|total_sum:'asignado'|floatformat:2|intcomma }}</strong></td>
                            <td class="text-right"><strong>{{ porclasep|total_sum:'ejecutado'|floatformat:2|intcomma }}</strong></td>
                        </tr>
                    </table>
                </div>
            {% endif%}
            <!-- /fin oim-tabla4 nacional-->
            <!-- maribel 20/07 oim-tabla4-municipal -->
            {% if municipio %}
                <div class="col-md-7">
                	{% descargar_excel "oim8" %}
                    <h3>Ranquin de recaudación por habitante categoría municipal "{{ mi_clase.clasificacion }}"</h3>
                <h4 class="text-info">Córdobas corrientes por habitante</h4>
                <table class="table table-condensed">
                    <tr class="info"><th>Posición</th><th>Municipios</th> <th>P. Inicial</th> <th>Ejecución</th></tr>
                    {% for row in otros %}
                        {% if municipio.slug == row.ingreso__municipio__slug%}
                        <tr class="info">
                        {% else %}
                        <tr>
                        {% endif %}
                            <td class="text-center"> {{forloop.counter}} </td>
                            <td>{{ row.ingreso__municipio__nombre }}</td>
                            <td class="text-right">{{ row.asignado_percent|intcomma }}</td>
                            <td class="info text-right">{{ row.ejecutado_percent|intcomma }}</td>
                        </tr>
                    {% endfor %}
                    <tr class="success">
                        <td colspan="2">TOTAL</td>
                        <td class="text-right">{{ otros|total_sum:'asignado'|floatformat:2|intcomma }}</td>
                        <td class="text-right">{{ otros|total_sum:'ejecutado'|floatformat:2|intcomma }}</td>
                        <td></td>
                    </tr>
                </table>
                </div>
            {% endif %}
            <!-- /fin oim-tabla4-municipal -->
        </div>
        <div class="col-md-12 graficos-azul">
          <div class="col-md-4">
          </div>
          <div class="col-md-6">
          </div>
        </div>
      </div>
      <div role="tabpanel" class="tab-pane fade" id="oimmodificacion" aria-labelledby="oimmodificacion-tab">
        <!-- maribel 20/07 oim-tabla5 -->
        {% if rubros|total_sum:'actualizado' > 0 %} <!--No mostramos tablas si no hay actualizacion --!>

        {% descargar_excel "oim4" %}
        <h3>Modificaciones al presupuesto municipal de ingresos</h3>
        <h4 class="text-info">Millones de córdobas corrientes
            <a class="btn btn-success" role="button" data-toggle="collapse" href="#collapsemodificacion"  aria-expanded="false" aria-controls="collapsemodificacion">Ver gráfico</a>
        </h4>
         <div class="collapse" id="collapsemodificacion">
            <div class="well">
                <div class="col-md-3 pull-left">Las transferencias se asigna cada año según los criterios establecido en la ley de transferencias y están distribuidas en gatos corrientes y capital.<p></div>
                <div class="col-md-7"><div id='comparativo3'> Chart will be rendered here </div></div>
            </div>
        </div>
        <div class="col-md-8">
        <table class="table table-condensed">
            <tr class="info"> <th>Rubros del ingreso</th> <th>Inicial</th> <th>Actualizado</th> <th>Modificación</th> <th>Ejecutado</th> <th><a href="#" data-toggle="tooltip" data-original-title="Ejecutado/Actualizado" class="link-info">%</a></th></tr>
            {% for row in rubros %}
                <tr>
                    <td class="pull-left">{{ row.subsubtipoingreso__origen__nombre}}</td>
                    <td class="text-right">{{ row.asignado|intcomma }}</td>
                    <td class="text-right">{{ row.actualizado|intcomma }}</td>
                    <td class="text-right">{% if row.actualizado %}{{ row.actualizado|sub:row.asignado|intcomma }}{% else %}0{% endif %}</td>
                    <td class="text-right">{{ row.ejecutado|intcomma }}</td>
                    {% if row.actualizado %}
                        <td class="montos">{{ row.ejecutado|div:row.actualizado|mul:100|floatformat:1|intcomma }}%</td>
                    {% endif %}
                </tr>
            {% endfor %}
            <tr class="success bold">
                <td>TOTAL</td>
                <td class="text-right">{{ rubros|total_sum:'asignado'|intcomma }}</td>
                <td class="text-right">{{ rubros|total_sum:'actualizado'|intcomma }}</td>
                {% with sum_asignado=rubros|total_sum:'asignado' %}
                    <td class="montosi text-right">
                    {% if rubros|total_sum:'actualizado' %}
                        {{ rubros|total_sum:'actualizado'|sub:sum_asignado|intcomma }}
                    {% else %}
                        0
                    {% endif %}
                </td>
                {% endwith %}
                <td class="text-right">{{ rubros|total_sum:'ejecutado'|intcomma }}</td>
                {% with sum_actualizado=rubros|total_sum:'actualizado' %}
                    <td class="montos text-right">
                        {% if sum_actualizado %}
                        {{ rubros|total_sum:'ejecutado'|div:sum_actualizado|mul:100|floatformat:1|intcomma}}
                        {% endif %}
                    </td>
                {% endwith %}
            </tr>
        </table>
        <br />

        <!-- /fin oim-tabla5 -->
        <!-- maribeli 20/07 oim-tabla6 -->
        {% descargar_excel "oim5" %}
        <h3>Modificacion al presupuesto municipal del ingreso de personal permanente</h3>
        <h4 class="text-info">Millones de córdobas corrientes</h4>
        <table class="table table-condensed">
            <tr class="info"> <th>Rubros del ingreso</th> <th>Inicial</th> <th>Actualizado</th> <th>Modificación</th> <th>Ejecutado</th> <th>
                    <a href="#" data-toggle="tooltip" data-original-title="Ejecutado/Inicial" class="link-info">%</a></th></tr>
            {% for row in rubrosp %}
                <tr>
                    <td class="pull-left">{{ row.subtipoingreso__nombre }}</td>
                    <td class="text-right">{{ row.asignado|intcomma }}</td>
                    <td class="text-right">{{ row.actualizado|intcomma }}</td>
                    <td class="text-right">{% if row.actualizado %}{{ row.actualizado|sub:row.asignado|intcomma }}{% else %}0{% endif %}</td>
                    <td class="text-right">{{ row.ejecutado|intcomma }}</td>
                    {% if row.actualizado %}
                        <td class="montos text-right">{{ row.ejecutado|div:row.actualizado|mul:100|floatformat:1|intcomma }}%</td>
                    {% endif %}
                </tr>
            {% endfor %}
            <tr class="success bold">
                <td>TOTAL</td>
                <td class="text-right">{{ rubros|total_sum:'asignado'|intcomma }}</td>
                <td class="text-right">{{ rubros|total_sum:'actualizado'|intcomma }}</td>
                {% with sum_asignado=rubros|total_sum:'asignado' %}
                    <td class="montos text-right">
                    {% if rubros|total_sum:'actualizado' %}
                        {{ rubros|total_sum:'actualizado'|sub:sum_asignado|intcomma }}
                    {% else %}
                        0
                    {% endif %}
                </td>
                {% endwith %}
                <td class="text-right">{{ rubros|total_sum:'ejecutado'|intcomma }}</td>
                {% with sum_actualizado=rubros|total_sum:'actualizado' %}
                    <td class="montos text-right">
                        {% if sum_actualizado %}
                        {{ rubros|total_sum:'ejecutado'|div:sum_actualizado|mul:100|floatformat:1|intcomma}}
                        {% endif %}
                    </td>
                {% endwith %}
            </tr>
        </table>
        </div>
        {% else %}
            <div class="intro text-center">No hay modificaciones disponibles para este año</div>
        {% endif %}
      </div>
      <div role="tabpanel" class="tab-pane fade" id="oimorigen" aria-labelledby="oimorigen-tab">
        <!--maribel 20/07 oim-tabla 7 -->
        <div class="col-md-6">
        	{% descargar_excel "oim6" %}
            <h3>Ejecución presupuestaria del ingreso sector municipal</h3>
            <h4 class="text-info">Millones de córdobas corrientes</h4>
            <a class="btn btn-success" role="button" data-toggle="collapse" href="#collapsehistorico"  aria-expanded="false" aria-controls="collapsehistorico">ver gráfico</a>

         <div class="collapse" id="collapsehistorico">
            <div class="well">
                <h4 class="text-primary">Presupuesto Inicial y Final</h4>
                {% if not municipio %}
                    <div id='comparativo2' class="col-md-8"> Chart will be rendered here </div>
                {% else %}
                    <div id='comparativo_anios' class="col-md-8"> Chart will be rendered here </div>
                {% endif %}
            </div>
        </div>
        <table class="table table-condensed">
            <table class="table table-condensed">
                <tr class="info"><th>Años</th> <th>Inicial</th> <th>Ejecutado</th> <th><a href="#" data-toggle="tooltip" data-original-title="Ejecutado/Actualizado" class="link-info">%</a></th></tr>
                {% for row in anuales %}
                <tr>
                    <td>{{ row.ingreso__anio }}</td>
                    <td class="text-right">{{ row.asignado|million|intcomma }}</td>
                    <td class="text-right">{{ row.ejecutado|million|intcomma }}</td>
                    {% if row.asignado %}
                        <td class="montos text-right">{{ row.ejecutado|div:row.asignado|mul:100|floatformat:1 }}%</td>
                    {% endif %}
                 </tr>
                {% endfor %}
                <tr class="success bold">
                    <td>TOTAL</td>
                    <td>{{ anuales|total_sum:'asignado'|intcomma }}</td>
                    <td>{{ anuales|total_sum:'ejecutado'|intcomma }}</td>
                    {% with total_sum_asignado=anuales|total_sum:'asignado' %}</td>
                    <td class="montos">{{ anuales|total_sum:'ejecutado'|div:total_sum_asignado|mul:100|floatformat:1 }}%</td>
                    {% endwith %}
                </tr>
            </table>
        </div>
        <!-- /fin oimtabla7 -->
        <br clear="all" >
        	{% descargar_excel "oim7" %}
          <h3>Ingresos por períodos</h3>
          <h4 class="text-info">Millones de c&oacute;rdoba corrientes</h4>
          <table class="table table-condensed">
            <tr class="info">
              <th></th>
              {% for year in year_list %}
                <th class="text-center">{{ year }}</th>
              {% endfor %}
            </tr>
            {% for key, data in porano.items %}
             <tr>
               <td class="text-left">{{ key }}</td>
               {% for year in year_list %}
                 <td class="text-right">{{ data|keyvalue:year|intcomma }}</td>
               {% endfor %}
               <!-- old-fashioned way:
               {% for subkey, subdata in data.items %}
               <td>{{ subkey }} = {{ subdata| intword}}</td>
               {% endfor %}
                -->
             </tr>
           {% endfor %}
          </table>
          <div class="col-md-12">
          </div>
          <div class="clear"></div>
          <hr />
          <div id='barra' class="col-md-10 visible-xs"> Chart will be rendered here </div>
          <!--div class="col-md-12">
            <div id='asignado_barra' class="col-md-10"> Chart will be rendered here </div>
          </div-->
      </div>
    </div>
</div>


{% endblock %}


<script>
$('#oimTab a').click(function (e) {
  e.preventDefault()
    $(this).tab('show')
    }
    
$(document).ready(function(){
        $('[data-toggle="tooltip"]').tooltip({
                        placement : 'top'
                    });
        });)
</script>
