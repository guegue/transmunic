{% extends "_indicator.html" %}
{% load static thumbnail chartit %}
{% load humanize %}
{% load mathfilters %}
{% load core_extras %}
{# TODO: Replace this by django-seo2 #}
{% block titulo %}
{{ municipio }}
{% endblock %}

{% block custom_header_links %}
    <link rel="stylesheet" href="{% static 'css/linea_basic.css' %}">
    <link rel="stylesheet" href="{% static 'css/pe-icon-7-stroke.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/charts.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/bubbletree.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/horizontal-timeline.css' %}" />
{% endblock %}
{% block custom_footer_scripts %}
    <script type="text/javascript" src="{% static 'js/jquery-migrate.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.history.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/raphael-min.js' %}"></script>
    <script type="text/javascript  " src="{% static 'js/Tween.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bubbletree.js' %}"></script>
    <script type="text/javascript" src="http://assets.openspending.org/openspendingjs/master/lib/aggregator.js"></script>
    <script type="text/javascript" src="{% static 'js/cofog.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bar-chart.js' %}"></script>
    <script type="text/javascript">
        $(function() {
            var $tooltip = $('<div class="tooltip">Tooltip</div>');
            $('.bubbletree').append($tooltip);
            $tooltip.hide();

            var tooltip = function(event) {
                if (event.type == 'SHOW') {
                    // show tooltip
                    vis4.log(event);
                    $tooltip.css({
                        left: event.mousePos.x + 4,
                        top: event.mousePos.y + 4
                    });
                    $tooltip.html(event.node.label+' <b>'+event.node.famount+'</b>');
                    var bubble = event.target;

                    $tooltip.show();
                } else {
                    // hide tooltip
                    $tooltip.hide();
                }
            };
            var data = {{ bubble_data|safe }};
            $.each( data['children'], function( key, value ) {
                data['children'][key]['color'] =  vis4color.fromHSL(key/data.children.length*360, .7, .5).x;
                var node_color =  vis4color.fromHSL(key/data.children.length*360, .7, .5).x;
                $.each(data['children'][key]['children'], function(j, val){
                    data['children'][key]['children'][j]['color'] =  vis4color.fromHex(node_color).lightness('*'+(.5+Math.random()*.5)).x;
                });
            });

            new BubbleTree({
                data: data,
                container: '.bubbletree',
                bubbleType: 'icon',
                bubbleStyles: {
                    'cofog': BubbleTree.Styles.Cofog
                },
                formatValue: function(value) {
                    return 'C$ ' + value + 'M';
                }
            });
        });
    </script>
    <script>
    $('#oimTab a').click(function (e) {
        e.preventDefault();
        $(this).tab('show')
    });
    $(document).ready(function(){
            $('[data-toggle="tooltip"]').tooltip({
                            placement : 'top'
                        });
            });
    </script>
    <script src="{% static 'js/highcharts.js' %}"></script>
    <script src="{% static 'js/pma.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/horizontal-timeline.js' %}"></script>
    {% if municipio and charts.4 %}
    {{ charts|load_charts:"ejecutado, ejecutado_column, comparativo_anios, comparativo2,comparativo3, tipo, asignado_barra, barra" }}
    {% else %}
    {{ charts|load_charts:"ejecutado, ejecutado_column, comparativo2,tipo,comparativo3,comparativo_anios" }}
    {% endif %}
{% endblock %}

    {% block header_title %}
    <h2 class="text-center">{% if municipio %}<strong>{{ municipio }}</strong><br/>{% endif %}</h2>
<hr class="pma-line-5"/>
        <h4 class="text-center"><strong>Origen de los Ingresos {% if year %}{{ year }}{% else %}2015 {% endif %}</strong></h4>

        <p class="text-center metric-description container"> Son los ingresos que capta el sector público para realizar sus actividades, es decir, es el dinero percibido por el gobierno para financiar sus gastos públicos</p>

    {% endblock %}

    {% block header_summary %}
    <div class="col-md-4">
        <div class="info-box">
            <span class="info-box-icon pma-icon initial">
            </span>
            <div class="info-box-content">
                <span class="info-box-text">Inicial {{ asignado|million|intcomma }}</span>
            </div>
            <!-- /.info-box-content -->
        </div>
        <!-- /.info-box -->
    </div>
    <div class="col-md-4">
        <div class="info-box">
            <span class="info-box-icon pma-icon executed">
            </span>
            <div class="info-box-content">
                <span class="info-box-text">
                {% if year != '2016' %}
                Ejecutado {{ ejecutado|million|intcomma }}
                {% endif %}
                </span>
                <span class="info-box-number pma-green"></span>
            </div>
            <!-- /.info-box-content -->
        </div>
        <!-- /.info-box -->
    </div>
    <div class="col-md-4">
        <div class="info-box">
            <span class="info-box-icon pma-icon municipality-category">
            </span>
            <div class="info-box-content">
                {% if municipio %}
                {% endif %}
                <span class="info-box-text">Categor&iacute;a de municipio {{ mi_clase.clasificacion }}</span>
                <span class="info-box-number pma-green"></span>
            </div>
            <!-- /.info-box-content -->
        </div>
        <!-- /.info-box -->
    </div>
    {% endblock %}

{% block section1 %}
<div class="container">
    <div class="row">
        <h2> <strong>Detalle de Ingresos</strong> <br/> del período</h2>
        <hr class="pma-line-2">
        <div class="col-md-7">
            <div class="chart-update col-md-1 float-left">
                    <span class="pma-icon pe-7s-bubble pma-fg-gray"
                        aria-hidden="true" id="chart-bubble-1"></span>
                    <span id="chart-pie-1" class="pma-icon pe-7s-graph
                        pma-fg-gray" aria-hidden="true"></span>
                    <span id="chart-bar-1" class="pma-icon pe-7s-graph3 pma-fg-gray" aria-hidden="true"></span>
                    <span class="pma-icon pe-7s-graph2 pma-fg-gray"
                        aria-hidden="true" id="icons"></span>
            </div>
            <div class="col-md-11 bubbletree-container chart-container">
                <div id="bubble-1" class="bubbletree-wrapper view-main">
                    <div class="bubbletree"></div>
                </div>
                <div id="ejecutado" class="view-alternative"> Pastel Ejecucion por
                Rubros </div>
                <div id="ejecutado_column" class="view-alternative"> Barras Ejecucion por
                Rubros </div>
                <div id="comparativo2" class="view-alternative"> Chart will be rendered here
                </div>
                <div id="icons" class="view-alternative">
                </div>
            </div>
        </div>
        <div class="col-md-5 table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr class="">
                        <th>Rubros de ingresos</th>
                        <th class="text-right">Inicial</th>
                        <th class="text-right">Ejecutado</th>
                    </tr>
                </thead>
                {% for row in rubros %}
                <tr>
                    <td>{{ row.subsubtipoingreso__origen__nombre}}</td>
                    <td class="text-right">{{ row.inicial_asignado|million|intcomma }}</td>
                    <td class="text-right">{{ row.ejecutado|million|intcomma|default:"0" }}</td>
                </tr>
                {% endfor %}
                <tfoot>
                    <tr class="">
                        <td>TOTAL</td>
                        <td class="text-right">{{ asignado|million|intcomma }}</td>
                        <td class="text-right">{{ejecutado|million|intcomma|default:"0" }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block section2 %}
<div class="container">
    <div class="row">
        <div class="col-md-6">
        </div>
        <div class="col-md-6 table-responsive">
            {% if not municipio %}
            <h2><strong>Recaudación por habitante</strong><br/>Córdobas Corrientes</h2>
            <hr class="pma-line-1">
            <h3>  según categoría de municipios</h3>
            <table class="table table-condensed">
                <tr class="">
                    <th>Categoría de municipio</th>
                    <th>Presupuestado</th>
                    {% if year != '2016' %}<th>Ejecutado</th>{% endif %}</tr>
                {% for row in porclasep %}
                <tr>
                    <td class="text-center">{{ row.clasificacion }}</td>
                    <td class="text-right">{% if row.asignado %}{{ row.asignado|floatformat:2|intcomma }}{% else %} 0 {% endif %}</td>
                    {% if year != '2016' %}
                    <td class="text-right">{% if row.ejecutado %}{{ row.ejecutado|floatformat:2|intcomma }} {% else %} 0 {% endif %}</td>
                    {% endif %}
                </tr>
                {% endfor %}
                <tr class="">
                    <td><strong>Media NacionaL</strong></td>
                    <td class="text-right"><strong>{{ porclasep|total_sum:'asignado'|floatformat:2|intcomma }}</strong></td>
                    <td class="text-right"><strong>{{ porclasep|total_sum:'ejecutado'|floatformat:2|intcomma }}</strong></td>
                </tr>
            </table>
            {% endif%}
        </div>
    </div>
</div>
{% endblock %}

{% block section3 %}
<div class="cd-horizontal-timeline loaded pma-gradient">
    <div class="timeline">
        <div class="events-wrapper">
            <div class="events" style="width: {{ otros|length|mul:300 }}px;">
                <ol>
                    {% for row in otros|dictsortreversed:"asignado_percent" %}
                    <li><a href="#0" data-date="{% now "SHORT_DATETIME_FORMAT" %} 00:{{ forloop.counter }}" {% if municipio.slug == row.ingreso__municipio__slug%} class="selected"{% endif %} style="left: {{ forloop.counter|mul:300 }}px;">{{ row.ingreso__municipio__nombre }}</a></li>
                    {% endfor %}
                </ol>

                <span class="filling-line" aria-hidden="true" style="transform: scaleX(0.0772222);"></span>
            </div> <!-- .events -->
        </div> <!-- .events-wrapper -->

        <ul class="cd-timeline-navigation">
            <li><a href="#0" class="prev inactive">Prev</a></li>
            <li><a href="#0" class="next">Next</a></li>
        </ul> <!-- .cd-timeline-navigation -->
    </div> <!-- .timeline -->

    <div class="events-content">
        <ol>
                    {% for row in otros|dictsortreversed:"asignado_percent" %}
                    <li{% if municipio.slug == row.ingreso__municipio__slug%} class="selected"{% endif %} data-date="{% now "SHORT_DATETIME_FORMAT" %} 00:{{ forloop.counter }}">
                <h4>{{ row.ingreso__municipio__nombre }}</h4>
            </li>
                    {% endfor %}
        </ol>
    </div> <!-- .events-content -->

    <div class="container">
        <div class="row">
            <div class="col-md-12">
            {% if year == '2016' %}
            <h2>Recaudación por habitante</h2>
            {% else %}
            <h2><strong>Ranking de recaudación </strong> <br>
                por habitante categoría municipal
                "{{ mi_clase.clasificacion }}"</h2>
            {% endif %}
            <hr class="pma-line-3" />
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-md-12 table-responsive">
                <h4 class="text-info text-info-ranking">Córdobas corrientes por habitante</h4>
                <table class="table table-condensed table-striped pma-bg-white">
                    <thead class="thead-inverse">
                        <tr class="bg-primary">
                        <th class="text-center"><strong>Posición</strong></th>
                        <th class="text-center"><strong>Municipios</strong></th>
                        <th class="text-center"><strong>P. Inicial</strong></th>{% if year != '2016' %}
                        <th class="text-center"><strong>Ejecución</strong></th>{% endif %}</tr>
                    </thead>
                    {% if ejecutado <= 0 %}
                    {% for row in otros|dictsortreversed:"asignado_percent" %}
                    {% if municipio.slug == row.ingreso__municipio__slug%} <tr class="info">
                        {% else %}
                        <tr>
                            {% endif %}
                            <td class="text-center"> {{forloop.counter}} </td>
                            <td>{{ row.ingreso__municipio__nombre }}</td>
                            <td class="text-right">{{ row.asignado_percent|intcomma }}</td>
                            {% if year != '2016' %}
                            <td class="text-right">{{ row.ejecutado_percent|intcomma }}</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                        {% else %}
                        {% for row in otros %}
                        {% if municipio.slug == row.ingreso__municipio__slug%}
                        <tr class="info">
                            {% else %}
                            <tr>
                                {% endif %}
                                <td class="text-center"> {{forloop.counter}} </td>
                                <td>{{ row.ingreso__municipio__nombre }}</td>
                                <td class="text-right">{{ row.asignado_percent|intcomma }}</td>
                                {% if year != '2016' %}
                                <td class="text-right">{{ row.ejecutado_percent|intcomma }}</td>
                                {% endif %}
                            </tr>
                            {% endfor %} {% endif %}
<!--
                            <tr class="">
                                <td colspan="2">TOTAL</td>
                                <td class="text-right">
                                    {% if numerador > 0 %}
                                        {% with numerator=otros|total_sum:'asignado' denominator=otros|total_sum:'poblacion' %} {{ numerator|div:denominator|floatformat:2|intcomma }} {% endwith %}
                                    {% endif %}
                                </td>
                                {% if year != '2016' %}
                                <td class="text-right">
                                    {% if denominador > 0 %}
                                        {% with numerator=otros|total_sum:'ejecutado' denominator=otros|total_sum:'poblacion' %} {{ numerator|div:denominator|floatformat:2|intcomma }} {% endwith %}
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                        -->
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block section4 %}
<div class="container wide">
    <div class="row">
        <div class="col-md-12 text-center">
            <h2><strong>Información</strong> <br> Histórica
                "{{ mi_clase.clasificacion }}"</h2>
            <hr class="pma-line-4" />
            <section class="cd-horizontal-timeline loaded">
                <div class="timeline">
                    <div class="events-wrapper">
                        <div class="events" style="width: {{ otros|length|mul:300 }}px;">
                            <ol>
                                {% for history_year in year_list %}
                                <li><a href="#0" data-date="01/01/{{ history_year }}"
                                {% if history_year = year|add:"0" %} class="selected" {% endif %}
                                style="left:{{ forloop.counter|mul:300 }}px;">{{ history_year }}</a></li>
                                {% endfor %}
                            </ol>

                            <span class="filling-line" aria-hidden="true" style="transform: scaleX(0.0772222);"></span>
                        </div> <!-- .events -->
                    </div> <!-- .events-wrapper -->

                    <ul class="cd-timeline-navigation">
                        <li><a href="#0" class="prev inactive">Prev</a></li>
                        <li><a href="#0" class="next">Next</a></li>
                    </ul> <!-- .cd-timeline-navigation -->
                </div> <!-- .timeline -->

                <div class="events-content">
                    <ol>
                        {% for history_year in year_list %}
                        <li data-date="01/01/{{ history_year }}"
                            {% if history_year = year|add:"0" %} class="selected" {% endif %}>
                            <h4>{{ municipio }} {{ history_year }}</h2>
                          <table class="table table-condensed">
                            <tr class="info">
                              <th></th>
                              {% for year in year_list %}
                              <th class="text-center">{{ year }}
                                  {% if periodo_list|keyvalue:year == 'A' %}*Actualizado*{% endif %}</th>
                              {% endfor %}
                            </tr>
                            {% for key, data in porano.items %}
                             <tr>
                               <td class="text-left">{{ key }}</td>
                               {% for year in year_list %}
                               <td class="text-right">{{ data|keyvalue:year|million|intcomma }}</td>
                               {% endfor %}
                               <!-- old-fashioned way:
                               {% for subkey, subdata in data.items %}
                               <td>{{ subkey }} = {{ subdata| intword}}</td>
                               {% endfor %}
                                -->
                             </tr>
                           {% endfor %}
                          </table>
                        </li>
                        {% endfor %}
                    </ol>
                </div> <!-- .events-content -->
            </section>
        </div>
    </div>
</div>
{% endblock %}

{% block section6 %}
{% endblock %}

{% block section7 %}
<div class="pma-gradient">
    <div class="container">
        <div class="row" id="other-metrics-links">
            <div class="col-md-3">
                <h3 class="other-metrics-title"><strong>Otros Indicadores</strong><br/>
                que podés consultar</h3>
            </div>
            <div class="col-md-3 container-metrics-links">
                <a href="">Origen de Gastos </a>
                <br>
                <a href="">Destinos de Inversión</a>

            </div>
            <div class="col-md-3 container-metrics-links">
                <a href="">Gastos de Funcionamiento </a>
                <br>
                <a href="">Ahorro Corriente de Inversión</a>
            </div>
            <div class="col-md-3 container-metrics-links">
                <a href="">Gastos de Personal </a>
                <br>
                <a href="">Ejecución Presupuestaria</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
